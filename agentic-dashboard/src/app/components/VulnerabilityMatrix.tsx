import { ArrowDownRight, ArrowUpRight, Minus } from "lucide-react";
import type { VulnerabilitySlice } from "@/app/data/mock-data";

type Props = {
  items: VulnerabilitySlice[];
};

const severityPalette: Record<VulnerabilitySlice["severity"], string> = {
  Critical: "bg-rose-500/20 text-rose-600 border border-rose-200/60",
  High: "bg-amber-500/20 text-amber-600 border border-amber-200/60",
  Medium: "bg-sky-500/20 text-sky-600 border border-sky-200/60",
  Low: "bg-emerald-500/20 text-emerald-600 border border-emerald-200/60",
};

export function VulnerabilityMatrix({ items }: Props) {
  const families = Array.from(new Set(items.map((item) => item.family)));
  const severities: VulnerabilitySlice["severity"][] = [
    "Critical",
    "High",
    "Medium",
    "Low",
  ];

  const aggregate = (family: string, severity: string) =>
    items.find(
      (item) => item.family === family && item.severity === severity,
    ) ?? { family, severity, count: 0, delta: 0 };

  const deltaChip = (delta: number) => {
    if (delta > 0) {
      return (
        <span className="inline-flex items-center gap-1 text-xs font-medium text-rose-500">
          <ArrowUpRight className="size-3" />
          +{delta}
        </span>
      );
    }
    if (delta < 0) {
      return (
        <span className="inline-flex items-center gap-1 text-xs font-medium text-emerald-500">
          <ArrowDownRight className="size-3" />
          {delta}
        </span>
      );
    }
    return (
      <span className="inline-flex items-center gap-1 text-xs font-medium text-slate-400">
        <Minus className="size-3" />
        0
      </span>
    );
  };

  return (
    <section className="rounded-3xl border border-slate-200 bg-white/70 p-6 backdrop-blur">
      <header className="flex items-center justify-between pb-4">
        <div>
          <h2 className="text-lg font-semibold text-slate-900">
            Vulnerability Coverage
          </h2>
          <p className="text-sm text-slate-500">
            Severity distribution by platform family with daily deltas.
          </p>
        </div>
        <span className="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">
          Continuous scans Â· Last 6 hours
        </span>
      </header>

      <div className="overflow-hidden rounded-2xl border border-slate-100 bg-white shadow-sm">
        <table className="min-w-full divide-y divide-slate-100 text-sm">
          <thead className="bg-slate-50 text-xs uppercase text-slate-500">
            <tr>
              <th className="px-4 py-3 text-left font-semibold">Family</th>
              {severities.map((severity) => (
                <th key={severity} className="px-4 py-3 text-left font-semibold">
                  {severity}
                </th>
              ))}
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-50">
            {families.map((family) => (
              <tr key={family} className="odd:bg-white even:bg-slate-50/40">
                <td className="px-4 py-4 text-sm font-medium text-slate-900">
                  {family}
                </td>
                {severities.map((severity) => {
                  const slice = aggregate(family, severity);
                  return (
                    <td key={severity} className="px-4 py-4">
                      <div
                        className={`inline-flex w-full flex-col gap-1 rounded-xl px-3 py-2 text-left ${severityPalette[severity]}`}
                      >
                        <span className="text-lg font-semibold">
                          {slice.count}
                        </span>
                        {deltaChip(slice.delta)}
                      </div>
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>
  );
}
